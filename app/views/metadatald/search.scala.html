@()(implicit user: Option[models.User])

@main("Search metadata") {
    <h2>Search by metadata</h2>
    <div class="row">
        <div class="panel panel-default">
            <div class="panel-body">
                <form class="form top-padding" id="metadata-search">

                    <div id="basic-search-container">
                        <!-- ANY/ALL DROPDOWN -->
                        <div class='form-group col-lg-4 col-md-4'>
                            <select id='add-metadata-grouping'>
                                <option value='AND'>Match ALL of the selected terms</option>
                                <option value='OR'>Match ANY of the selected terms</option>
                            </select>
                        </div>

                        <!-- ADD TERM BTN -->
                        <div class="form-group col-lg-8 col-md-8">
                            <a class='btn btn-default' id='add-clause' onclick='getBasicDefinitions(2)'>
                                <span class='glyphicon glyphicon-plus'></span> Add term</a>
                        </div>

                        <!-- SET OF TERM ROWS (populated in script below) -->
                        <div id="metadata-search-rows"></div>
                    </div>

                    <!-- ADVANCED SEARCH BOX -->
                    <div class="form-group col-lg-10 col-md-10">
                        <br/>
                        <a id="adv-search-label" onclick='toggleAdvanced()'>Show Advanced Search</a><br/>
                        <div id="adv-search-container" hidden=True>
                            You can use grouping syntax in the Advanced Search box that is not possible with the basic interface.
                            Basic search will be hidden when you start typing directly into the Advanced Search box.
                            <textarea type="text" rows=3 class="form-control" id="adv-search" placeholder="Type query here"></textarea>
                        </div>
                    </div>

                    <!-- SUBMIT BTN -->
                    <div class="form-group col-lg-4 col-md-4">
                        <button type="submit" class="btn btn-primary"><span class="glyphicon glyphicon-search"></span> Search</button>
                        <span id="mt-search-feedback"></span>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <div class="row top-padding">
        <div class="col-lg-6 col-md-6"><h2>Datasets</h2><div id="datasets-results"></div></div>
        <div class="col-lg-6 col-md-6"><h2>Files</h2><div id="files-results"></div></div>
    </div>
    <div class="row top-padding">
        <div id="getmore" class="col-lg-12 col-md-12 text-center"></div>
    </div>
    <link rel="stylesheet" href="@routes.Assets.at("stylesheets/chosen.css")">
    <script src="@routes.Assets.at("javascripts/chosen.jquery.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/handlebars-v1.3.0.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/handlebars-loader.js")" type="text/javascript"></script>
    <script>
        var row_list = [];
        $("#adv-search").hide()
        $("#add-metadata-grouping").select2({
            theme: "bootstrap",
            allowClear: false,
            width: "100%"
        }).on("change", function(e) { console.log("change"); updateAdvancedSearchFromBasic(); });
        document.getElementById("adv-search").onkeyup = function() { toggleBasic(false); };

        getBasicDefinitions(1)

        // Add a new row to the set of criteria
        function getBasicDefinitions(rowId) {
            var rowStr = String(rowId);

            // Basic row definition
            $("#metadata-search-rows").append(
                $("<p><div id='metadata-clause-"+rowStr+"'>" +
                    <!-- FIELD SELECTOR DROPDOWN -->
                    "<div class='form-group col-lg-4 col-md-4'>" +
                        "<select id='add-metadata-select-"+rowStr+"'><option value=''></option></select></div>" +
                    <!-- OPERATOR DROPDOWN -->
                    "<div class='form-group col-lg-2 col-md-2'> <select id='add-metadata-operator-"+rowStr+"'>" +
                        "<option value=':'>contains</option>" +
                        "<option value='=='>equals</option>" +
                        "<option value='!='>does not equal</option>" +
                        "<option value='>'>greater than</option>" +
                        "<option value='<'>less than</option>" +
                    "</select></div>" +
                    <!-- VALUE FIELD -->
                    "<div class='form-group col-lg-4 col-md-4'>" +
                        "<input type='text' class='form-control' id='v-"+rowStr+"' placeholder='Type value here'>" +
                    "</div>" +
                    <!-- REMOVE ROW BUTTON -->
                    "<div class='form-group col-lg-2 col-md-2'>" +
                    "<button class='btn' id='remove-"+rowStr+"' onclick='removeRow("+rowStr+")'>" +
                    "<span class='glyphicon glyphicon-minus'></span></button></div>" +
                "</div>"
                )
            );
            document.getElementById("add-clause").onclick = function () { getBasicDefinitions(rowId+1); };
            document.getElementById("v-"+rowStr).onkeyup = function() { updateAdvancedSearchFromBasic(); };
            row_list.push(rowStr);

            // Add theme to operator/grouping dropdowns
            $("#add-metadata-operator-"+rowStr).select2({
                theme: "bootstrap",
                allowClear: false,
                width: "100%"
            }).on("change", function(e) { updateAdvancedSearchFromBasic() });
            $("#add-metadata-grouping-"+rowStr).select2({
                theme: "bootstrap",
                allowClear: false,
                width: "100%"
            }).on("change", function(e) { updateAdvancedSearchFromBasic() });

            // fetch metadata definitions
            var request = jsRoutes.api.Metadata.getDefinitionsDistinctName().ajax({
                type: 'GET',
                contentType: "application/json"
            });
            request.done(function (response, textStatus, jqXHR) {
                var fields = response;

                $("#add-metadata-select-"+rowStr).empty()
                for (var i = 0; i < fields.length; i++) {
                    var elem = $("<option></option>");
                    elem.attr("data-type", fields[i].json.type);
                    elem.attr("data-id", fields[i].id);
                    elem.attr("value", fields[i].json.uri);
                    elem.text(fields[i].json.label);
                    $("#add-metadata-select-"+String(rowId)).append(elem);
                }

                // Select box will populate as user types, with metadata field autocomplete suggestions
                $("#add-metadata-select-"+rowStr).select2({
                    theme: "bootstrap",
                    placeholder: "Select a type or field key",
                    allowClear: true,
                    width: "100%",
                    ajax: {
                        url: function(filter) {
                            // Get autocomplete results if typing; otherwise return standard set of definitions
                            if (filter.term == null || filter.term == "") {
                                return jsRoutes.api.Metadata.getDefinitionsDistinctName().url
                            }
                            else {
                                return jsRoutes.api.Metadata.getAutocompleteName(filter.term).url
                            }
                        },
                        processResults: function(data, page) {
                            return {
                                results: data.map(function(x) {
                                    if (typeof(x) == 'object') {
                                        // MetadataDefinitions
                                        return {text: x.json.label, id: x.id}
                                    } else {
                                        // autocomplete fields
                                        return {text: x, id: x}
                        }})};}
                    }
                }).on("change", function(e) { updateAdvancedSearchFromBasic() })
            });

            request.fail(function (jqXHR, textStatus, errorThrown){
                console.error("The following error occured: " + textStatus, errorThrown);
                var errMsg = "You must be logged in to retrieve metadata definitions";
                if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                    notify("Metadata was not added due to : " + errorThrown, "error");
                }
            });
        }

        // Construct a JSON object with search information
        function generateSearchObject() {
            var searchObj = [];
            for (var row=0; row<row_list.length; row++) {
                var rowkey = $("#add-metadata-select-"+row_list[row]+" :selected").text();
                var rowop = $("#add-metadata-operator-"+row_list[row]).val();
                var rowval = $("#v-"+row_list[row]).val();

                // Ignore any terms without a value
                if (rowval != "") {
                    if (rowkey.indexOf('.') > -1) {
                        var keyvals = rowkey.split('.')
                        var extractorKey = keyvals[0]
                        var leafKey = keyvals[keyvals.length-1]
                    } else {
                        var extractorKey = null
                        var leafKey = rowkey
                    }

                    searchObj.push({
                        "field_key": rowkey,
                        "operator": rowop,
                        "field_value": rowval,
                        "extractor_key": extractorKey,
                        "field_leaf_key": leafKey
                    });
                }
            }
            return searchObj;
        }

        function search(key, value, count) {
            count = count || 10;
            if ( key != "" && value != "" ) {
                var test = generateSearchObject();
                var request = jsRoutes.api.Metadata.searchByMultipleKeyValue(JSON.stringify(test), $("#add-metadata-grouping").val(), count).ajax({
                    type: 'GET',
                    contentType: "application/json"
                });

                request.done(parseSearchResults);

                request.fail(function (jqXHR, textStatus, errorThrown){
                    console.error("The following error occured: " + textStatus, errorThrown);
                });

                return;
            }

            $( "#mt-search-feedback" ).text( " Not valid!" ).show().fadeOut( 2000 );
        }

        function removeRow(rowId) {
            var rowStr = String(rowId);
            $("#metadata-clause-"+rowStr).remove();
            row_list.splice(row_list.indexOf(rowStr), 1);
            updateAdvancedSearchFromBasic();
        }

        // Show or hide basic search elements; default is to toggle between
        function toggleBasic(mode) {
            // mode true=show, false=hide
            var bsc = $("#basic-search-container");
            if (mode==null) { mode = !bsc.is(':visible'); }

            //
            if (mode==false && bsc.is(':visible')) {
                bsc.hide();
                toggleAdvanced(true);
            } else if (mode==true && !bsc.is(':visible')) {
                bsc.show();
                toggleAdvanced(false);
            }
        }

        // Show or hide advanced search box; default is to toggle between
        function toggleAdvanced(mode) {
            // mode true=show, false=hide
            var asc = $("#adv-search-container");
            if (mode==null) { mode = !asc.is(':visible'); }

            if (mode==false && asc.is(':visible')) {
                // If we're hiding advanced, make sure basic is visible
                toggleBasic(true);
                $("#adv-search").hide();
                asc.hide();
                $("#adv-search-label").text("Show Advanced Search");
            } else if (mode==true && !asc.is(':visible')) {
                asc.show();
                $("#adv-search").show();
                updateAdvancedSearchFromBasic();
                $("#adv-search-label").text("Hide Advanced Search");
            }
        }

        // When Advanced goes from hidden to visible, or it is visible and basic dropdowns change, repopulate it
        function updateAdvancedSearchFromBasic() {
            var asc = $("#adv-search");
            var groupType = $("#add-metadata-grouping").val(); // AND, OR
            var searchTerms = generateSearchObject()

            var searchStr = ""
            for (var term=0; term<searchTerms.length; term++) {
                var field_key = searchTerms[term]["field_key"];
                var operator = searchTerms[term]["operator"];
                var field_val = searchTerms[term]["field_value"];

                if (term > 0) {
                    searchStr += groupType+" ";
                }

                // Wrap multi-term strings in quotes
                if (field_key.indexOf(" ") > -1) { field_key = '"'+field_key+'"'; }
                if (field_val.indexOf(" ") > -1) { field_val = '"'+field_val+'"'; }
                searchStr += "("+field_key + operator + field_val+") ";
            }
            asc.val(searchStr);
        }

        function parseSearchResults(response, textStatus, jqXHR) {
            $( "#datasets-results" ).empty();
            $( "#files-results" ).empty();

            var datasets = response.datasets;
            if (datasets.length == 0) $('#datasets-results').append("No datasets found");
            for (var i=0; i<datasets.length; i++) {
                var modalTemplate = Handlebars.getTemplate("@routes.Assets.at("templates/metadata/search_dataset_result")");
                var html = modalTemplate({'url': jsRoutes.controllers.Datasets.dataset(datasets[i].id).url, 'name': datasets[i].name});
                $('#datasets-results').append(html);
            }

            var files = response.files;
            if (files.length == 0) $('#files-results').append("No files found");
            for (var i=0; i<files.length; i++) {
                var modalTemplate = Handlebars.getTemplate("@routes.Assets.at("templates/metadata/search_file_result")");
                var html = modalTemplate({'url': jsRoutes.controllers.Files.file(files[i].id).url, 'name': files[i].name});
                $('#files-results').append(html);
                // TODO: example search strings
                // TODO: Support API direct calls
            }

            $('#getmore').html('<a id="showmore" class="btn btn-link"><span class="glyphicon glyphicon-hand-down"></span> Show more results</a>');
            $('#showmore').click( function() { search(key, value, count+10); } );
        }

        // form submission
        $( "form[id='metadata-search']").submit(function( event ) {
            event.preventDefault();
            if ($("#adv-search-container").is(':visible')) {
                // Submit advanced search string directly - user responsible for syntax correctness
                var query = $("#adv-search").val();

                var k = $("#add-metadata-select-1 option:selected").text();
                var predicate = $("#add-metadata-select-1 option:selected").val();
                var v = $( "#v-1" ).val();
                search(k, v);
            } else {
                // Submit contents of basic search rows
                var query = generateSearchObject();

                var k = $("#add-metadata-select-1 option:selected").text();
                var predicate = $("#add-metadata-select-1 option:selected").val();
                var v = $( "#v-1" ).val();
                search(k, v);
            }

        });
    </script>
}