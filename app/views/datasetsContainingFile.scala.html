@(file: models.File, datasets: List[models.Dataset])(implicit user: Option[models.User])

@import play.api.libs.json.Json

<script src="@routes.Assets.at("javascripts/errorRedirect.js")" type="text/javascript"></script>

<table id="datasTable">
    @datasets.map { dataset =>
    <tr><td><a href="@(routes.Datasets.dataset(dataset.id))">@Html(dataset.name)</a>&nbsp;&nbsp;&nbsp;&nbsp;</td>
        <td><a href="#" style="font-style:italic;" onclick="removeFromDataset('@(dataset.id)','@(dataset.name)',event)">Detach</a></td></tr>
    }
</table>

@if(user.isDefined) {
    <form class="form-inline requiresLogin requiresLoginCommunity">
        <div class="input-group input-group-sm col-md-8">
            <select id="datasetAddSelect" class="form-control" style="width: 100%">
            </select>
            <span class="input-group-btn">
                <button class="btn btn-default btn-large" id="addDatasBtn" title="Add File to Dataset">
                    <span class="glyphicon glyphicon-plus"></span>
                </button>
            </span>
        </div>
    </form>
}

<script>
    $("#datasetAddSelect").select2({
        theme: "bootstrap",
        placeholder: "Select a dataset",
        allowClear: true,
        ajax: {
            url: function(params) {
                return jsRoutes.api.Datasets.list(params.term, null, 10).url;
            },
            data: function(params) {
                return { title: params.term };
            },
            processResults: function(data, page) {
                return {results: data.filter(function(x) {
                    return $.inArray(x.id, @Html(Json.stringify(Json.toJson(datasets.map(x=>x.id.toString())))));
                }).map(function(x) {
                    return {
                        text: x.datasetname,
                        id: x.id
                    }
                })};
            }
        }
    });
</script>
<script>
        $('body').on('click','#addDatasBtn',function(e){
            if($("#doesNotExistErrorDatasets").css('display') == 'inline')
                return;
            if($("#selectingInputDatasets").val() == ""){
                $("#doesNotExistErrorDatasets").css('display','inline');
                return;
            }

            var selectedId = $("#datasetAddSelect").val();
            var selectedName = $("#datasetAddSelect option:selected").text();
            var request = jsRoutes.api.Datasets.attachExistingFile(selectedId, "@file.id").ajax({
                   type: 'POST',                   
                 });
            
            request.done(function (response, textStatus, jqXHR){
                console.log("Response " + response);
                $("#datasetAddSelect option[value=" + selectedId + "]").remove();
                $("#selectingInputDatasets").val("");
                var i = 1;
                var tableLength = $("#datasTable tbody tr").length;
                var dsUrl = jsRoutes.controllers.Datasets.dataset(selectedId).url
                while(i <= tableLength && $("#datasTable tbody tr:nth-child("+i+") td:nth-child(1) a").text() < selectedName)
                    i++;
                if(i <= tableLength)
                    $("#datasTable tbody tr:nth-child("+i+")").before("<tr><td><a href='" + dsUrl + "'>"+selectedName+"</a>"
                            + "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFromDataset(\""+selectedId+"\",\""+selectedName+"\",event)'>Detach</a></td></tr>"
                            );
                else if(tableLength > 0)
                    $("#datasTable tbody tr:nth-child("+(i-1)+")").after("<tr><td><a href='" + dsUrl + "'>"+selectedName+"</a>"
                            + "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFromDataset(\""+selectedId+"\",\""+selectedName+"\",event)'>Detach</a></td></tr>"
                            );
                else{
                    if($("#datasTable tbody").length == 0)
                        $("#datasTable").append("<tbody></tbody>");
                    $("#datasTable tbody").append("<tr><td><a href='" + dsUrl + "'>"+selectedName+"</a>"
                            + "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeFromDataset(\""+selectedId+"\",\""+selectedName+"\",event)'>Detach</a></td></tr>"
                            );
                    }
            });
            
            request.fail(function (jqXHR, textStatus, errorThrown){
            	console.error("The following error occured: "+textStatus, errorThrown);
                var errMsg = "You must be logged in to add a file to a dataset.";                    
                if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                    notify("The file was not added to the dataset due to : " + errorThrown, "error");
                }
            });
        });

        function removeFromDataset(datasetId, datasetName,event){
            var request = jsRoutes.api.Datasets.detachFile(datasetId, "@file.id").ajax({
                   type: 'DELETE'
                 });
            request.done(function (response, textStatus, jqXHR){
                console.log("Response " + response);
                $(event.target.parentNode.parentNode).remove();
                var i = 1;
                var selectLength = $("#datasetAddSelect option").length;
                while(i <= selectLength && $("#datasetAddSelect option:nth-child("+i+")").text() < datasetName)
                    i++;
                if(i <= selectLength)
                    $("#datasetAddSelect option:nth-child("+i+")").before("<option value='"+datasetId+"'>"+datasetName+"</option>");
                else if(selectLength > 0)
                    $("#datasetAddSelect option:nth-child("+(i-1)+")").after("<option value='"+datasetId+"'>"+datasetName+"</option>");
                else
                    $("#datasetAddSelect").append("<option value='"+datasetId+"'>"+datasetName+"</option>");

                $("#datasetAddSelect").combobox();
            });
            request.fail(function (jqXHR, textStatus, errorThrown){
            	console.error("The following error occured: "+textStatus, errorThrown);
                var errMsg = "You must be logged in to remove a file from a dataset.";                    
                if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                    notify("The file was not removed from the dataset due to : " + errorThrown, "error");
                }
            });
        }

</script>

@if(!user.isDefined) {
    <script language="javascript">
	    $(".requiresLogin").css("display", "none");
    </script>
}
