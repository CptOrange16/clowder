@(myForm: Form[Dataset], filesList: List[(String, String)])(implicit flash: play.api.mvc.Flash, user: Option[securesocial.core.Identity])



@import helper._
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

<!-- 
The majority of this file has now been changed to be based off elements from the demonstration HTML page
of the blueimp jQuery File Upload library. An open source project locatd here: http://blueimp.github.io/jQuery-File-Upload/
 -->

<!-- Force latest IE rendering engine or ChromeFrame if installed -->
<!--[if IE]>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<![endif]-->

<!-- blueimp Gallery styles - downloaded to make the resource local -->
<link rel="stylesheet" href="@routes.Assets.at("stylesheets/file-uploader/blueimp-gallery.min.css")">
<!-- Generic page styles -->
<link rel="stylesheet" href="@routes.Assets.at("stylesheets/file-uploader/style.css")">
<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
<link rel="stylesheet" href="@routes.Assets.at("stylesheets/file-uploader/jquery.fileupload.css")">
<link rel="stylesheet" href="@routes.Assets.at("stylesheets/file-uploader/jquery.fileupload-ui.css")">
<!-- CSS adjustments for browsers with JavaScript disabled -->
<noscript><link rel="stylesheet" href="@routes.Assets.at("stylesheets/file-uploader/jquery.fileupload-noscript.css")"></noscript>
<noscript><link rel="stylesheet" href="@routes.Assets.at("stylesheets/file-uploader/jquery.fileupload-ui-noscript.css")"></noscript>

@main("Medici 2.0") {
  <script>
    function clearUpload(){
        $('#file').val('');
    }        
  </script> 
<div class="container">
  <div class="page-header">
    <h1>Create New Dataset</h1>
  </div>
  
    <div class="row">
    <div class="col-md-12">
    <div>
        <span class="error" id="messageerror">An Error Message</span>
    </div>
    @if(myForm.hasErrors) {
        <div class="alert alert-error">
            <p>Please fix all errors</p>
        </div>
    }
    @flash.get("error").map { message =>
        <div class="alert alert-error">
            <p>@message</p>
        </div>
    }
    <table style="width: 100%; margin-bottom: 40px;">
        <tr>
            <td style="width: 20%; vertical-align:top;" class="input-table-cell">Name:</td>
            <td style="width: 35%; vertical-align:top;" class="input-table-cell">
                <textarea cols=40 rows=4 type="text" id="name"></textarea>                                            
            </td>
            <td style="vertical-align:top;" class="input-table-cell">
                <span class="error" id="nameerror"> The name is a required field</span><br>
            </td>
        </tr>
        <tr>
            <td style="width: 20%; vertical-align:top;" class="input-table-cell">Description:</td>
            <td style="width: 35%; vertical-align:top;" class="input-table-cell">
                <textarea cols=40 rows=4 type="text" id="description"></textarea>                                            
            </td>
            <td style="vertical-align:top;" class="input-table-cell">
                <span class="error" id="descerror"> This description is a required field</span><br>
            </td>
        </tr>
        <tr>
            <td style="width: 20%; vertical-align:top;" class="input-table-cell">Show File Previews for:</td>
            <td class="input-table-cell">
                <input type="radio" name="radiogroup" value="DatasetLevel" id="everywhere" checked> Everywhere&nbsp;&nbsp;&nbsp;</input>
                <input type="radio" name="radiogroup" value="FileLevel"> On File Page&nbsp;&nbsp;&nbsp;</input>
                <input type="radio" name="radiogroup" value="None"> Nowhere&nbsp;&nbsp;&nbsp;</input>
            </td>
        </tr>
        <tr>
            <td>
                <button style="margin-top: 10px;" class="btn btn-default" title="Reset Values" onclick="return resetValues();">
		          <span class="glyphicon glyphicon-refresh"></span> Reset Fields
		        </button>
            </td>
        </tr>
    </table>
    <p>
    <!-- 
    <fieldset id="nameDescrFieldSet">
      @inputText(myForm("name"), '_label -> "Name")
      @textarea(myForm("description"), '_label -> "Description")
    </fieldset>
    <fieldset>
      @select(
        myForm("existingFile"),
        ("__nofile" -> "--NONE--") +: filesList.map{ oneFile =>
            oneFile._1 -> (oneFile._2)
        },
        '_label -> "Choose existing file, or upload a new one. NOTE: Single file only."
    )
    </fieldset>
    <fieldset id="datasetRadioFieldSet">
      @inputRadioGroup(
          myForm("datasetLevel").copy(value=myForm("datasetLevel").value.orElse(Some("DatasetLevel")) ),
          options = options("DatasetLevel"->"Everywhere","FileLevel"->"On file page","None"->"Nowhere"),
          '_label -> "Show file preview(s)",
          '_error -> myForm("datasetLevel").error.map(_.withMessage("Select where the preview will be viewable.")))
    </fieldset>
    -->
    
    <div class="tabbable" id="createDatasetTabbable"> <!-- Only required for left/right tabs -->
              <ul class="nav nav-tabs">
                <li class="active" id="tab1"><a href="#tab1" data-toggle="tab">New Files</a></li>
                <li id="tab2"><a href="#tab2" data-toggle="tab">Existing Files</a></li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane active" id="tab1">              
                    <!-- The file upload form used as target for the file upload widget -->
				    <form id="fileupload" action='@routes.Datasets.submit' method="POST" enctype="multipart/form-data">
				        <!-- Redirect browsers with JavaScript disabled to the origin page -->
				        <noscript>Javascript is required in order to use the uploader to create a new dataset.</noscript>
				        
				        <input type="hidden" name="name" id="hiddenname" value="not set">
				        <input type="hidden" name="description" id="hiddendescription" value="not set">
				        <input type="hidden" name="datasetLevel" id="hiddenlevel" value="DatasetLevel">
				        <input type="hidden" name="existingFile" id="hiddenexisting" value="__nofile">
				        <input type="hidden" name="datasetid" id="hiddenid" value="__noval">
				        <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
				        <div class="row fileupload-buttonbar">
				            <div class="col-lg-7">
				                <!-- The fileinput-button span is used to style the file input field as button -->
				                <span class="btn btn-primary fileinput-button">
				                    <i class="glyphicon glyphicon-plus"></i>
				                    <span>Add files</span>
				                    <!-- The file input had "multiple" removed for the current dataset creation method. -->
				                    <input type="file" name="files[]" multiple>				                    
				                </span>
				                <button type="submit" class="btn btn-default start" title="Create the Dataset">
				                    <i class="glyphicon glyphicon-upload"></i>
				                    <span>Create Dataset</span>
				                </button>
				                <button type="reset" class="btn btn-default cancel">
				                    <i class="glyphicon glyphicon-ban-circle"></i>
				                    <span>Cancel upload</span>
				                </button>
				                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				                <label>
				                    <input type="checkbox" class="toggle"> Select all
				                </label>
				                <button type="button" class="btn btn-link delete" style="margin-bottom: 0px">
				                    <i class="glyphicon glyphicon-trash"></i>
				                    <span>Delete selected</span>
				                </button>
				                <!-- The global file processing state -->
				                <span class="fileupload-process"></span>
				                
				            </div>
				            <!-- The global progress state -->
				            <div class="col-lg-5 fileupload-progress fade">
				                <!-- The global progress bar -->
				                <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
				                    <div class="progress-bar progress-bar-success" style="width:0%;"></div>
				                </div>
				                <!-- The extended global progress state -->
				                <div class="progress-extended">&nbsp;</div>
				            </div>
				        </div>
				        <!-- The table listing the files available for upload/download -->
				        <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
				    </form>
                <script type="text/javascript">
                    //Flag to signal that dataset creation has started                
	                var asynchStarted = false;
                    //The id of the new dataset, to share among the file uploads
	                var id = "__notset";
                    //The original data to be submitted, for the initial file that handles the ajax call
                    //to create the dataset
	                var origData = null;
	                
                    $(document).ready(function() {
                        clearErrors();
                        enableFields();
                        resetDatasetItems();                        
                    });                                        
                    
                    function disableFields() {
                    	$('#name').attr("disabled", true);
                    	$('#description').attr("disabled", true);
                    	$("input[name=radiogroup]").attr('disabled', true);                    	
                    }
                    
                    function enableFields() {
                    	$('#name').attr("disabled", false);
                        $('#description').attr("disabled", false);
                        $("input[name=radiogroup]").attr('disabled', false);                    	
                    }
                    
                    function clearErrors() {
                    	$('.error').hide();
                    }
                    
                    function resetDatasetItems() {
                    	asynchStarted = false;
                    	id = "__notset";
                    	origData = null;
                    	//Ensure both tabs are shown
                    	$('#tab1').show();
                    	$('#tab2').show();
                    }
                    
                    function clearFields() {
                    	$('#name').val("");
                    	$('#description').val("");
                    }
                    
                    function resetValues() {
                    	enableFields();
                    	resetDatasetItems();
                    	clearFields();
                    	$('#everywhere').prop('checked', true);
                    }
                    
                    //Utility method to allow calls for files to be uploaded to wait until the dataset ID is
                    //in place before finally proceeding with their submit.
                    function holdForId(data) {
                       console.log("In hold for Id");
                   	   setTimeout(function(){
                   	      if (id == "__notset") {
                   	    	  console.log("About to recurse");
                   	    	  // recurse
                              holdForId(data); 
                   	      }
                   	      else {
                   	    	  console.log("holdForId - submitting data");
                   	    	  data.submit();
                   	      }                   	    
                   	  }, 500);
                   	}
                    
	                $(function () {	                	                 
	                	//Callback for any submit call, whether it is the overall one, or individual files
	                    $('#fileupload').bind('fileuploadsubmit', function (e, data) {
	                    	//First, check if the id value is set and if an asych call is started. 
	                    	if (asynchStarted && id == "__notset") {	                    		
	                            //If so, wait for the ID to be set.
	                    		holdForId(data);
	                    		return false;
	                    	}
	                    	else {
	                    		  //In this case either asynch has started or the ID is set, so trip the flag 
	                    		  //and set the original data in the first case, and this is basically a no-op
	                    		  //in the latter case.	                    		  
	                    		  asynchStarted = true;
	                    		  origData = data;
	                    	}
	                    	console.log("submit callback")	                    	
	                    	//Remove error messages if present
	                    	clearErrors();
	                    	
	                    	//Disable input elements
	                    	disableFields();
	                    	
	                    	//Hide the other tab
	                    	$('#tab2').hide();
	                    	
	                    	//Update the input we are adding to the form programmatically      
	                    	var name = $('#name');
	                        var desc = $('#description');
	                        
	                        //Add errors and return false if validation fails
	                        var error = false;
	                        if (!name.val()) {
	                        	$('#nameerror').show();
	                        	error = true;
	                        }
	                        if (!desc.val()) {                                
                                $('#descerror').show();
                                error = true;
                            }
	                        if (error) {
	                        	data.context.find('button').prop('disabled', false);
	                        	return false;
	                        }
	                        
	                        //No field errors, so set the input values	                        
	                        var radios = document.getElementsByName("radiogroup");
	                        console.log('submit binding');                        
	                        for (var elem in radios) {
	                            if (radios[elem].checked) {
	                                $('#hiddenlevel').val(radios[elem].value);
	                            }
	                        }
	                        $('#hiddenname').val(name.val());
	                        $('#hiddendescription').val(desc.val());
	                        console.log("-- setting ID in submit callback, it is " + id);
	                        $('#hiddenid').val(id);
	                       
	                        if (id == "__notset") {
	                        	//Case for the primary file that is submitted. It will create the dataset and obtain the id.
	                        	console.log("About to call ajax for createEmptyDataset")
	                        	var jsonData = JSON.stringify({"name":name.val(), "description":desc.val()});
		                        var request = null;		                         	                        
	                            request = jsRoutes.api.Datasets.createEmptyDataset().ajax({
	                                data: jsonData,
	                                type: 'POST',
	                                contentType: "application/json",
	                            });
	                        	                        	                        
		                        request.done(function (response, textStatus, jqXHR){	                            
		                            //Sucessful creation of the dataset. Set the id so that all files can
		                            //proceed to finish their submit.
		                            id = response["id"];
		                            console.log("Successful response from createEmptyDataset. ID is " + id);
		                            $('#hiddenid').val(id);   
		                            //Now call the submit for the primary file that was submitted that triggered the dataset
		                            //creation.
		                            origData.submit();
		                        });
	
	
		                        request.fail(function (jqXHR, textStatus, errorThrown){
		                            console.error("The following error occured: " + textStatus, errorThrown);
		                            var errMsg = "You must be logged in to create a new dataset.";                                
		                            if (!checkErrorAndRedirect(jqXHR, errMsg)) {
		                            	$('#messageerror').html("Error in creating dataset. : " + errorThrown);
		                            	$('#messageerror').show();
		                            }  
		                        });
		                        //This block is the primary file, so don't submit yet, don't re-enable the buttons either.
		                        //The submission of this data will occur on the successful callback for the dataset creation.
		                        return false;
                            }

	                    });
	                	
	                    $('#fileupload').bind('fileuploaddone', function (e, data) {	   
	                    	console.log("--- In DONE callback ---");
	                    });
	                });                                    
                </script>
    
				    <!-- The blueimp Gallery widget -->
					<div id="blueimp-gallery" class="blueimp-gallery blueimp-gallery-controls" data-filter=":even">
					    <div class="slides"></div>
					    <h3 class="title"></h3>
					    <a class="prev">‹</a>
					    <a class="next">›</a>
					    <a class="close">×</a>
					    <a class="play-pause"></a>
					    <ol class="indicator"></ol>
					</div> 
                </div> <!-- End 1st Tab content -->
                <div class="tab-pane" id="tab2">
                  @form(action = routes.Datasets.submit(), 'enctype -> "multipart/form-data", 'class -> "form-horizontal") {     			        
			        <button id="uploadCLearBtn" style="position: relative;  margin-top:10px; margin-bottom:10px;" onclick="clearUpload();return false;">Clear</button>
			        <fieldset>
			          @select(
			            myForm("existingFile"),
			            ("__nofile" -> "--NONE--") +: filesList.map{ oneFile =>
			                oneFile._1 -> (oneFile._2)
			            },
			            '_label -> "or select an existing file"
			        )
			        </fieldset>			        
			        <div class="form-actions">
			          <button type="submit" class="btn btn-primary btn-large" title="Create the Dataset"><span class="glyphicon glyphicon-ok"></span> Create</button>
			        </div>
			       }
                </div> <!-- End 2nd Tab content -->
              </div>
            </div>
    </div>
    </div>
</div>       
    

<!-- The template to display files available for upload -->
<script id="template-upload" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-upload fade">
        <td>
            <span class="preview"></span>
        </td>
        <td>
            <p class="name">{%=file.name%}</p>
            <strong class="error text-danger"></strong>
        </td>
        <td>
            <p class="size">Processing...</p>
            <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
        </td>
        <td>
            {% if (!i && !o.options.autoUpload) { %}
                <button class="btn btn-primary start" disabled>
                    <i class="glyphicon glyphicon-upload"></i>
                    <span>Start</span>
                </button>
            {% } %}
            {% if (!i) { %}
                <button class="btn btn-default cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Cancel</span>
                </button>
            {% } %}
        </td>
    </tr>
{% } %}
</script>
<!-- The template to display files available for download -->
<script id="template-download" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-download fade">
        {% if (file.deleteUrl) { %}
        <td>
            <input type="checkbox" name="delete" value="1" class="toggle">
        </td>
        {% } %}
        <td>
            <span class="preview">
                {% if (file.thumbnailUrl) { %}
                    <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                {% } %}
            </span>
        </td>
        <td>
            <p class="name">
                {% if (file.url) { %}
                    <a href="{%=file.url%}" title="{%=file.name%}" target="_blank" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                {% } else { %}
                    <span>{%=file.name%}</span>
                {% } %}
            </p>
            {% if (file.error) { %}
                <div><span class="label label-danger">Error</span> {%=file.error%}</div>
            {% } %}
        </td>
        <td>
            <span class="size">{%=o.formatFileSize(file.size)%}</span>
        </td>
        <td>
            {% if (file.deleteUrl) { %}
                <button class="btn btn-danger delete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}"{% if (file.deleteWithCredentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                    <i class="glyphicon glyphicon-trash"></i>
                    <span>Delete</span>
                </button>
            {% } else { %}
                <button class="btn btn-default cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Cancel</span>
                </button>
            {% } %}
        </td>
    </tr>
{% } %}
</script>

<!-- downloaded to make the resource local -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.min.js")"></script>
<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included - downloaded to make the resource local -->
<script src="@routes.Assets.at("javascripts/file-uploader/vendor/jquery.ui.widget.js")"></script>
<!-- The Templates plugin is included to render the upload/download listings - downloaded to make the resource local -->
<script src="@routes.Assets.at("javascripts/file-uploader/tmpl.min.js")"></script>
<!-- The Load Image plugin is included for the preview images and image resizing functionality - downloaded to make the resource local -->
<script src="@routes.Assets.at("javascripts/file-uploader/load-image.all.min.js")"></script>
<!-- The Canvas to Blob plugin is included for image resizing functionality - downloaded to make the resource local -->
<script src="@routes.Assets.at("javascripts/file-uploader/canvas-to-blob.min.js")"></script>
<!-- blueimp Gallery script - downloaded to make the resource local-->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.blueimp-gallery.min.js")"></script>
<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.iframe-transport.js")"></script>
<!-- The basic File Upload plugin -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.fileupload.js")"></script>
<!-- The File Upload processing plugin -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.fileupload-process.js")"></script>
<!-- The File Upload image preview & resize plugin -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.fileupload-image.js")"></script>
<!-- The File Upload audio preview plugin -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.fileupload-audio.js")"></script>
<!-- The File Upload video preview plugin -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.fileupload-video.js")"></script>
<!-- The File Upload validation plugin -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.fileupload-validate.js")"></script>
<!-- The File Upload user interface plugin -->
<script src="@routes.Assets.at("javascripts/file-uploader/jquery.fileupload-ui.js")"></script>
<!-- The main application script -->
<script src="@routes.Assets.at("javascripts/file-uploader/main.js")"></script>
<!-- The XDomainRequest Transport is included for cross-domain file deletion for IE 8 and IE 9 -->
<!--[if (gte IE 8)&(lt IE 10)]>
<script src="js/cors/jquery.xdr-transport.js"></script>
<![endif]-->
    
}
