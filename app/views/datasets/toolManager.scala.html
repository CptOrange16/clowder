@(instances: List[UUID], instanceMap: scala.collection.mutable.Map[UUID, services.ToolInstance])(implicit user: Option[models.User])

@import helper._
@import play.api.Play.current
@import services.ToolManagerPlugin
@import scala.io.Source
@import scala.xml.parsing.XhtmlParser


@main("Tool Manager") {
  <link rel="stylesheet" href="@routes.Assets.at("stylesheets/tableborder.css")" />

  <div class="row">
    <div class="col-md-12">
      <h1>Active Analysis Environments</h1>
    </div>
  </div>

  <div>
  @instances.map { instanceID =>
    @instanceMap.get(instanceID) match {
      case Some(inst) => {
          <div class = "panel panel-default" id="@instanceID-listitem">
            <div class="panel-body">
              <div class="row">
                <div class="col-md-12 col-sm-12 col-lg-12">

                  <h2>
                    @if(inst.url == "") {
                      @inst.name (not yet ready)
                    } else {
                      <a href="@inst.url.replace("\"","")" target="_blank">@inst.name</a>
                    }
                  </h2>

                  <div class ="row">
                    <div class="col-md-6 col-sm-6 col-lg-6">
                      <ul class="list-unstyled">
                        @inst.owner match {
                          case Some(u) => {
                            <li>Created by <a href= "@routes.Profile.viewProfile(u.email)"> @u.fullName </a></li>
                          }
                          case None => {}
                        }

                        <li>Environment: @Html(inst.toolType)</li>
                        <li>Created @inst.created.format("MMM dd, yyyy")</li>
                        <li>Updated @inst.updated.format("MMM dd, yyyy")</li>

                        <li>
                          <a class="btn btn-link" data-toggle="collapse" aria-expanded="false" aria-controls="collapseExample" href="#datasets-@inst.id">
                            <span class="glyphicon glyphicon-collapse-down" title="@inst.uploadHistory.keys.size datasets"></span> Expand upload history (@inst.uploadHistory.keys.size uploads)
                          </a>
                          <div class="collapse" id="datasets-@inst.id" aria-hidden="true">
                            <div class="well"> @{
                              var dsList = ""
                              instanceMap.get(instanceID) match {
                                case Some(ts) => {
                                  for ((dsId, dsName) <- ts.uploadHistory) {
                                    val dsURL = controllers.routes.Datasets.dataset(dsId).url
                                    dsList += "<a href="+dsURL+">"+dsName+"</a></br>"
                                  }
                                }
                                case None => {}
                              }
                              Html(dsList)
                            }
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div class="col-md-6 col-sm-6 col-lg-6">
                      <ul class="list-unstyled">
                          <li>
                            <a id='download-dataset-url' href="#" onclick="removeInstance('@inst.toolType','@instanceID')" class="btn btn-link"role="button">
                              <span class="glyphicon glyphicon-stop"></span>
                              Stop Instance
                            </a>
                          </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      case None => {}
    }
  }
  </div>

  <script>
    function removeInstance(toolType, instanceID) {
      // Get current status from ToolManagerPlugin and refresh sidebar table
      var request = new XMLHttpRequest();
      request.onreadystatechange = function() {
        if (request.readyState == 4 && request.status == 200) {
          location.reload();
        }
      }

      request.open("GET", jsRoutes.controllers.Datasets.removeInstance(toolType, instanceID).url, true);
      request.send();
    }
  </script>
}

