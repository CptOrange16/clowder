@(dataset: models.Dataset, comments: List[Comment], previews : Map[models.File, Array[(java.lang.String, String, String, String, java.lang.String, String, Long)]], md: Map[String,Any], usrmd: scala.collection.mutable.Map[String,Any], collectionsOutside: List[models.Collection], collectionsInside: List[models.Collection], filesOutside: List[models.File], rdfExported: Boolean)(implicit user: Option[securesocial.core.Identity])


@import helper._
@import collection.JavaConverters._
@import com.mongodb.casbah.Imports.DBObject
@import play.api.Play.current
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

	@printLevel(metadata: scala.collection.immutable.Map[String,Any]) = {		
		@for((key,value) <- metadata) {
			<li><b>@(key):</b>
			@if(value.isInstanceOf[String]) {
				@if(value.asInstanceOf[String].startsWith("http://") || value.asInstanceOf[String].startsWith("https://")) {
					<a href="@value">@value</a>
				} else {
					@value
				}
			} else {
				@if(value.isInstanceOf[java.lang.Integer]) {
					@value.toString
			    } else {
			    	@if(value.isInstanceOf[com.mongodb.BasicDBList]) {
			    		@value.toString.replace("[","").replace("]","")
			    	} else {
			    		<ul>
			    		@printLevel(value.asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
			    		</ul>
			    	}
			    }
			}</li>
		}
	}
	
	@printLevelUserMetadata(metadata: scala.collection.mutable.Map[String,Any]) = {
		<ul class="usr_md_">
		@for((key,value) <- metadata) {
			@if(value.isInstanceOf[com.mongodb.BasicDBList]){
				@for(listValue <- value.asInstanceOf[com.mongodb.BasicDBList]) {
						<li class="usr_md_"><b class="usr_md_">@(key):</b>
						@if(listValue.isInstanceOf[String]) {			
							<span class="usr_md_">@listValue</span><button class="usr_md_" type="button">Modify</button><button class="usr_md_" >Delete</button>
						} else {
								<button class="usr_md_" type="button">Add property</button><button class="usr_md_" type="button">Delete</button>@printLevelUserMetadata(listValue.asInstanceOf[DBObject].toMap.asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]])
						}</li>
				}
			}else{
				<li class="usr_md_"><b class="usr_md_">@(key):</b>
				@if(value.isInstanceOf[String]) {			
					<span class="usr_md_">@value</span><button class="usr_md_" type="button">Modify</button><button class="usr_md_" >Delete</button>
				} else {
						<button class="usr_md_" type="button">Add property</button><button class="usr_md_" type="button">Delete</button>@printLevelUserMetadata(value.asInstanceOf[DBObject].toMap.asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]])
				}</li>
			}	
		}
		</ul>
	}

@main("Dataset") {    

    <script src="@routes.Assets.at("javascripts/errorRedirect.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/updateLicenseInfo.js")" language="javascript"></script>
    <script src="@routes.Assets.at("javascripts/tinymce/tinymce.min.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("javascripts/combobox.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/datasetListProcess.js")" type="text/javascript"></script>
	<script>
		tinymce.init({selector:'.notesArea',
	    	theme: "modern",
	    	plugins: [
	    	          "advlist autolink lists link image charmap print preview hr anchor pagebreak",
	    	          "searchreplace wordcount visualblocks visualchars code fullscreen",
	    	          "insertdatetime media nonbreaking save table contextmenu directionality",
	    	          "template paste textcolor"
	    	      ],
	    	      toolbar1: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
	    	      toolbar2: "print preview media | forecolor backcolor emoticons",
	    	      image_advtab: true,
	    	      templates: [
	    	          {title: 'Test template 1', content: 'Test 1'},
	    	          {title: 'Test template 2', content: 'Test 2'}
	    	      ]
	    });
	</script>
    
	<div class="page-header">
		<h1 id="aboutname">@dataset.name</h1>
	</div>
	
	<div class="row">	
	
		<!-- left column -->
		<div class="col-md-8" id="filePrevsCol">
            @files.grid(previews.keys.toList)

    		
	    	<div class="tabbable" id="bottomDatasetTabbable"> <!-- Only required for left/right tabs -->
			  <ul class="nav nav-tabs">
			    <li class="active"><a href="#tab1" data-toggle="tab">Comments</a></li>
			    <li><a href="#tab2" data-toggle="tab">Metadata</a></li>
			    <li><a href="#tab3" data-toggle="tab">Notes</a></li>
			  </ul>
			  <div class="tab-content">
			    <div class="tab-pane active" id="tab1">
				      @if(user.isDefined) {
				      	  @commentform(dataset.id.stringify, api.routes.Datasets.comment(dataset.id).toString)
				      }
			 		  <div class="comment-threads unstyled" id="reply_@dataset.id.toString">
				      	 @comment(comments)
				      </div> 
			    </div>
			    <div class="tab-pane" id="tab2">
			      @metadata(dataset, md, usrmd, dataset.datasetXmlMetadata, rdfExported)
			    </div>
			    <div class="tab-pane" id="tab3">
			      @notesform(dataset.id.toString, api.routes.Datasets.setNotesHTML(dataset.id).toString, dataset.notesHTML.getOrElse(""))
			    </div>
			  </div>
			</div>	
			    		
		</div>

		<!-- right column -->
		<div class="col-md-4 col-left-border">
		  <!-- Dataset information elements -->
            <div id="aboutDiv" class="row ds-section-sm">
                <table>
                   <tr>
                    <td><b>Owner: </b></td>
                    <td id="aboutowner" style="padding-left:10px;"><a href= "@routes.Profile.viewProfile(dataset.author.email)"> @dataset.author.fullName </a></td>
                   </tr>
                   <tr>
                    <td style="vertical-align:top;"><b>Description: </b></td>
                    <td id="aboutdesc" style="padding-left:10px;">@dataset.description</td>
                   </tr>
                   <tr>
                    <td><b>Created: </b></td>
                    <td id="aboutcreate" style="padding-left:10px;">@dataset.created.format("MMM dd, yyyy")</td>
                   </tr>
                </table>
                <p>
                 @if(user.isDefined) {
                    <span class="button-bar">
                        <a class="btn btn-info btn-large accordion-toggle collapsed" data-toggle="collapse"
                           data-parent="#accordion7" href="#collapseSeven" id="editabout" style="padding-left:5px;"
                           title="Edit Dataset Information"><span class="glyphicon glyphicon-chevron-down"></span> Edit</a>
                    </span>
                    <!-- If user can delete, the button is enabled, otherwise the button is present but disabled to provide consistent UE. -->
                    @if(user.get.identityId.userId.equals(dataset.author.identityId.userId)){
                        <span class="align-right" style="padding-right:12px;">
                            <button id="deleteAndDetachButton" onclick="detachAndRemoveDatasetAndRedirect('@(dataset.id)','@(routes.Datasets.list(""))')" class="btn btn-primary" title="Delete the Dataset but do not Delete Contents">
                            <span class="glyphicon glyphicon-trash"></span> Delete</button>
                            <button id="deleteButton" onclick="removeDatasetAndRedirect('@(dataset.id)','@(routes.Datasets.list(""))')" class="btn btn-primary" title="Delete Dataset and Enclosed Contents">
                            <span class="glyphicon glyphicon-trash"></span> Delete All</button>
                        </span>
                    } else {
                        <span class="align-right" style="padding-right:12px;">
                            <button disabled id="deleteAndDetachButton" onclick="detachAndRemoveDatasetAndRedirect('@(dataset.id)','@(routes.Datasets.list(""))')" class="btn btn-primary" title="Delete the Dataset but do not Delete Contents">
                            <span class="glyphicon glyphicon-trash"></span> Delete</button>
                            <button disabled id="deleteButton" onclick="removeDatasetAndRedirect('@(dataset.id)','@(routes.Datasets.list(""))')" class="btn btn-primary" title="Delete Dataset and Enclosed Contents">
                            <span class="glyphicon glyphicon-trash"></span> Delete All</button>
                        </span>
                    }
                 }
            </div>
            <div id="collapseSeven" class="accordion-body collapse" style="padding:5px 9px 5px 6px;">
                <div class="panel panel-info">
                    <div class="panel-body">
                    @if(user.isDefined) {
                        <form class="form-inline" id="form2">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="width: 30%; vertical-align:top;">Name:</td>
                                    <td>
                                        <textarea cols=30 rows=4 type="text" id="editname">@dataset.name</textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width: 30%; vertical-align:top;">Description:</td>
                                    <td>
                                        <textarea cols=30 rows=4 type="text" id="editdesc">@dataset.description</textarea>
                                    </td>
                                </tr>
                            </table>
                            <br>

                            <button class="btn btn-primary" onclick="return updateAboutData('@dataset.id.stringify');" title="Update Information"><span class="glyphicon glyphicon-edit"></span> Submit</button>
                            <button class="btn btn-default" onclick="return closeAboutEdit();" title="Close Editor"><span class="glyphicon glyphicon-chevron-up"></span> Close</button>
                         </form>
                    }
                    </div>
                </div>
            </div>
                <script type="text/javascript" language="javascript">
                    function closeAboutEdit() {
                    //Reset the data to the current values
                    var text = $("#aboutdesc").text();
                    $("#editdesc").val(text);
                    text = $("#aboutname").text();
                    $("#editname").val(text);

                    //Close the edit form
                    $("#editabout").addClass('collapsed');
                    $("#collapseSeven").collapse('toggle');
                    return false;
                    }

                    function updateAboutData(datasetId) {
                        var description = $("#editdesc").val();
                        var name = $("#editname").val();
                        var encName = htmlEncode(name);
                        var encDescription = htmlEncode(description);
                        var jsonData = JSON.stringify({"description":encDescription, "name":encName});

                        var request = jsRoutes.api.Datasets.updateInformation(datasetId).ajax({
                            data: jsonData,
                            type: 'POST',
                            contentType: "application/json"
                        });

                        request.done(function (response, textStatus, jqXHR){
                            ///console.log("Response " + response);
                            //Sucessful update of the DB - update the interface

                            $("#aboutdesc").text(htmlDecode(encDescription));
                            $("#aboutname").text(htmlDecode(encName));

                            closeAboutEdit();
                        });

                        request.fail(function (jqXHR, textStatus, errorThrown){
                            console.error("The following error occured: "+textStatus, errorThrown);
                            var errMsg = "You must be logged in to update the information about a dataset.";
                            if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                                alert("The dataset information was not updated due to : " + errorThrown);
                            }
                        });

                        return false;
                    }
                </script>

                <script src="@routes.Assets.at("javascripts/htmlEncodeDecode.js")" language="javascript"></script>
                    <!-- End dataset information elements -->

			<div class="row ds-section-sm border-top">
					<!-- License elements -->
				<h4>License Information</h4>
				<table>
					<tr>
						<td><b>Type: </b></td>
						<td id="licensetextdata" style="padding-left:10px;">blank</td>
					</tr>
					<tr>
						<td><b>Holder: </b></td>
						<td id="rightsholderdata" style="padding-left:10px;">blank</td>
					</tr>
				</table>
				<p>
				@if(user.isDefined) {
					<a class="btn btn-link btn-sm accordion-toggle collapsed" data-toggle="collapse"
					data-parent="#accordion6" href="#collapseSix" id="editlicense"
					title="Edit License Information">
						<span class="glyphicon glyphicon-chevron-down"></span> Edit
					</a>
			}

				<div id="collapseSix" class="accordion-body collapse">
					<div class="panel panel-primary">
						<div class="panel-body">
						@if(user.isDefined) {
							@licenseform(dataset.id.stringify, dataset.licenseData, "dataset", dataset.author.fullName)
						}
						</div>
					</div>
				</div>

				<script type="text/javascript" language="javascript">
				$(document).ready(function() {
				//Will have to modify the if check to see if there is data that specifies what should be selected
				//Incoming data may specifiy the type of license, the name of the owner of the rights, the text
				//describing the license rights, the URL for the license, and whether or not downloading is
				//allowed.
				var datasetLicenseType = "@dataset.licenseData.m_licenseType";
				var datasetRightsHolder = "@dataset.licenseData.m_rightsHolder";
				var datasetLicenseText = "@dataset.licenseData.m_licenseText";
				var datasetLicenseUrl = "@dataset.licenseData.m_licenseUrl";
				var datasetAllowDownload = "@dataset.licenseData.m_allowDownload";
				var datasetImageBase = '@routes.Assets.at("images")';
				var datasetAuthorName = '@dataset.author.fullName';

				if (!@user.isDefined) {
				updateInterface(datasetLicenseType, datasetRightsHolder, datasetLicenseText, datasetLicenseUrl, datasetAllowDownload, datasetImageBase, datasetAuthorName);
				}
				});
				</script>
					<!-- End License elements -->
			</div>

			@if(user.isDefined) {
			<div class="row ds-section-sm border-top">
				<h4>Files</h4>

				<a href="#myModal" class="btn btn-default btn-xs" data-toggle="modal" id="fileUploadBtn" title="Add New File to Dataset" role="button">
				    <span class="glyphicon glyphicon-export"></span> Upload new file
				</a>

				<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				    <div class="modal-dialog">
				      <div class="modal-content">
				      @form(action = routes.Files.uploaddnd(dataset.id), 'enctype -> "multipart/form-data", 'role -> "form") {
				        <div class="modal-header">
				          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				          <h4 class="modal-title">Upload File</h4>
				        </div>
				        <div class="modal-body">
				 		  <div class="form-group">
						    <label for="exampleInputFile">New File</label>
						    <input type="file" id="query" name="File">
						    <p class="help-block">The file will be uploaded and added to this dataset.</p>
								    	Show file preview(s)
		          						<br/>				
		          						<input type="radio" name="datasetLevel" value="DatasetLevel" checked> Everywhere<br>
										<input type="radio" name="datasetLevel" value="FileLevel"> On file page<br>
										<input type="radio" name="datasetLevel" value="None"> Nowhere
						  </div>
				        </div>
				        <div class="modal-footer">
				          <button type="submit" class="btn btn-primary" title="Upload File"><span class="glyphicon glyphicon-open"> Upload</span></button>				          
				        </div>
				      }
				      </div><!-- /.modal-content -->
				    </div><!-- /.modal-dialog -->
				</div><!-- /.modal -->

                <div>Add existing file</div>
				<div class="ui-widget form-inline requiresLogin" id="filesUi">
                    <div class="input-group input-group-sm col-md-8">
                        <select id="filesAddSelect" data-inputid="selectingInputFiles" data-errorid="doesNotExistErrorFiles">
                            <option value="" selected="selected"></option>
                            @filesOutside.map { file =>
                                <option value="@(file.id)">@(file.filename)</option>
                            }
                        </select>
                        <span class="input-group-btn">
                            <button class="btn btn-default btn-xs" id="addFileBtn" title="Add Existing File">
                               <span class="glyphicon glyphicon-plus"></span>
                            </button>
                        </span>
                    </div>
					<span style="color:red;display:none;margin-top:10px;font-size:14px;font-family:Helvetica Neue,Helvetica,Arial,sans-serif" id="doesNotExistErrorFiles" >File does not exist or already added.</span>
				</div>
                
                <script>
                    $("#filesAddSelect").combobox();
                </script>
                <script>
                    $('body').on('click','#addFileBtn',function(e){
                        if($("#doesNotExistErrorFiles").css('display') == 'inline')
                            return;
                        if($("#selectingInputFiles").val() == ""){
                            $("#doesNotExistErrorFiles").css('display','inline');
                            return;
                        }

                        var selectedId = $("#filesAddSelect").val();
                        var selectedName = $("#filesAddSelect option:selected").text();
                        var request = $.ajax({
                               type: 'POST',
                               url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/datasets/"+"@dataset.id"+"/files/"+selectedId
                             });

                        request.done(function (response, textStatus, jqXHR){
                            console.log("Response " + response);
                            $("#filesAddSelect option[value=" + selectedId + "]").remove();
                            $("#selectingInputFiles").val("");
                            var i = 1;
                        });

                        request.fail(function (jqXHR, textStatus, errorThrown){
                        	console.error("The following error occured: "+textStatus, errorThrown);
                            var errMsg = "You must be logged in to add a file to a dataset.";
                            if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                                alert("The file was not added to the dataset due to : " + errorThrown);
                            }
                        });
                    });

                    function detachFile(fileId, fileName,event){
                        var request = $.ajax({
							type: 'POST',
							url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/datasets/"+"@dataset.id"+"/filesRemove/"+fileId+"/True"
						});
                        request.done(function (response, textStatus, jqXHR){
                            console.log("Response " + response);
                            $(event.target.parentNode.parentNode).remove();
                            var i = 1;
                            var selectLength = $("#filesAddSelect option").length;
                            while(i <= selectLength && $("#filesAddSelect option:nth-child("+i+")").text() < fileName)
                                i++;
                            if(i <= selectLength)
                                $("#filesAddSelect option:nth-child("+i+")").before("<option value='"+fileId+"'>"+fileName+"</option>");
                            else if(selectLength > 0)
                                $("#filesAddSelect option:nth-child("+(i-1)+")").after("<option value='"+fileId+"'>"+fileName+"</option>");
                            else
                                $("#filesAddSelect").append("<option value='"+fileId+"'>"+fileName+"</option>");

                            $("#filesAddSelect").combobox();
                                var nextHRs = $("#previewedFileName_"+fileId).nextAll("hr");
                                if(nextHRs.length > 0){
                                    nextHRs.first().remove();
                                }
                                else{
                                    var prevHRs = $("#previewedFileName_"+fileId).prevAll("hr");
                                    if(prevHRs.length > 0){
                                        prevHRs.first().remove();
                                    }
                                }
                            $("#previewedFileName_"+fileId).remove();
                            $("#filePrevContainer_"+fileId).remove();
                            $("#technicalMetadata_"+fileId).remove();
                            $("#fileUserMetadata_"+fileId).remove();
                        });
                        request.fail(function (jqXHR, textStatus, errorThrown){
                        	console.error("The following error occured: "+textStatus, errorThrown);
                            var errMsg = "You must be logged in to remove a file from a dataset.";
                            if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                                alert("The file was not removed from the dataset due to : " + errorThrown);
                            }       
                        });
                    }

                </script>
			</div>
			}
	
			<div class="row ds-section-sm border-top">
				<h4>Collections containing the dataset</h4>
				<table id="collTable">
				@collectionsInside.map { collection =>
					<tr><td><a href="@(routes.Collections.collection(collection.id))">@collection.name</a></td>
					<td><a href="#" class="requiresLogin" style="font-style:italic;" onclick="removeCollection('@(collection.id)','@(collection.name)',event)">Remove</a></td></tr>
				}
				</table>

				<div class="requiresLogin ui-widget requiresLoginCommunity" id="collectionsUi">
					    <div>Add to existing collection</div>
						<div class="input-group input-group-sm col-md-8"">
							<select id="collectionAddSelect"  data-inputid="selectingInputCollections" data-errorid="doesNotExistErrorCollections" style="vertical-align:center;">
							@collectionsOutside.map { collection =>
								@if(user.isDefined) {
									@if(!collection.author.isDefined){
										<option value="@(collection.id)">@(collection.name)</option>
									}
									@if(collection.author.isDefined){
										@if(user.get.identityId.userId.equals(collection.author.get.identityId.userId)){
											<option value="@(collection.id)">@(collection.name)</option>
										}
									}					
								}								
							}					  
							</select>
							<span class="input-group-btn">
								<button class="btn btn-primary btn-large" id="addCollBtn" title="Add Dataset To Collection" style="vertical-align:center;">
                                    <span class="glyphicon glyphicon-plus"></span>
                                </button>
							</span>
						</div><br/>
						<span style="color:red;display:none;margin-top:10px;font-size:14px;font-family:Helvetica Neue,Helvetica,Arial,sans-serif"  id="doesNotExistErrorCollections">Collection does not exist or already added.</span>
				
				</div>

				<script type="text/javascript">
						$("#collectionAddSelect").combobox();
						
	  					function selectClickChange() {
	  						var theSelectedColl = document.getElementById("collectionAddSelect");
	  						document.getElementById("selectCollectionInput").value = theSelectedColl.options[theSelectedColl.selectedIndex].text;
	  					}
	  					document.getElementById("collectionAddSelect").onchange = selectClickChange;
					</script>
				<script>
						$('body').on('click','#addCollBtn',function(e){
							if($("#doesNotExistErrorCollections").css('display') == 'block')
								return;
							if($("#selectingInputCollections").val() == ""){
								$("#doesNotExistErrorCollections").css('display','block');
								return;
							}
							
							var selectedId = $("#collectionAddSelect").val();
							var selectedName = $("#collectionAddSelect option:selected").text();
							var request = $.ajax({
							       type: 'POST',
							       url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/collections/"+selectedId+"/datasets/"+"@dataset.id"
							     });
							request.done(function (response, textStatus, jqXHR) {
								console.log ( "Response " + response ) ;
								$ ( "#collectionAddSelect option[value=" + selectedId + "]" ).remove ( ) ;
								$ ( "#selectingInputCollections" ).val ( "" ) ;
								var i = 1 ;
								var tableLength = $ ( "#collTable tbody tr" ).length ;
								while ( i <= tableLength && $ ( "#collTable tbody tr:nth-child(" + i + ") td:nth-child(1) a" ).text ( ) < selectedName )
								i ++ ;
								if ( i <= tableLength ) {
									$ ( "#collTable tbody tr:nth-child(" + i + ")" ).before ( "<tr><td><a href='" + window.location.protocol + "//" + window.location.hostname + ( window.location.port ? ':' + window.location.port : '' ) + "/collection/" + selectedId + "'>" + selectedName + "</a>"
									+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeCollection(\"" + selectedId + "\",\"" + selectedName + "\",event)'>Remove</a></td></tr>"
									) ;
								} else if(tableLength > 0) {
									$ ( "#collTable tbody tr:nth-child(" + ( i - 1 ) + ")" ).after ( "<tr><td><a href='" + window.location.protocol + "//" + window.location.hostname + ( window.location.port ? ':' + window.location.port : '' ) + "/collection/" + selectedId + "'>" + selectedName + "</a>"
									+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeCollection(\"" + selectedId + "\",\"" + selectedName + "\",event)'>Remove</a></td></tr>"
									) ;
								} else {
									if($("#collTable tbody").length == 0)
										$("#collTable").append("<tbody></tbody>");
									$("#collTable tbody").append("<tr><td><a href='"+window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/collection/"+selectedId+"'>"+selectedName+"</a>"
											+ "&nbsp;&nbsp;&nbsp;&nbsp;</td><td><a href='#' style='font-style:italic;' onclick='removeCollection(\""+selectedId+"\",\""+selectedName+"\",event)'>Remove</a></td></tr>"
									);
								}
							});
							request.fail(function (jqXHR, textStatus, errorThrown){
								console.error("The following error occured: " + textStatus, errorThrown);
                                var errMsg = "You must be logged in to add a dataset to a collection.";                                
                                if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                                    alert("The dataset was not added to the collection due to the following : " + errorThrown);
                                }  
					 		});				
						});
						
						function removeCollection(collectionId, collectionName,event){
							var request = $.ajax({
							       type: 'POST',
							       url: window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '')+"/api/collections/"+collectionId+"/datasetsRemove/"+"@dataset.id"+"/True"
							     });
							request.done(function (response, textStatus, jqXHR){
								console.log("Response " + response);	        
								$(event.target.parentNode.parentNode).remove();
								var i = 1;
						        var selectLength = $("#collectionAddSelect option").length;
						        while(i <= selectLength && $("#collectionAddSelect option:nth-child("+i+")").text() < collectionName)
						        	i++;
						        if(i <= selectLength)
						        	$("#collectionAddSelect option:nth-child("+i+")").before("<option value='"+collectionId+"'>"+collectionName+"</option>");
						        else if(selectLength > 0)
						        	$("#collectionAddSelect option:nth-child("+(i-1)+")").after("<option value='"+collectionId+"'>"+collectionName+"</option>");
						        else
						        	$("#collectionAddSelect").append("<option value='"+collectionId+"'>"+collectionName+"</option>");
						        
						        $("#collectionAddSelect").combobox();
							});	
							request.fail(function (jqXHR, textStatus, errorThrown){
								console.error("The following error occured: " + textStatus, errorThrown);
                                var errMsg = "You must be logged in to remove a dataset from a collection.";                                
                                if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                                    alert("The dataset was not removed from the collection due to : " + errorThrown);
                                }  
					 		});
						}
						
					</script>
			</div>
			
			<div class="row ds-section-sm border-top">
				<h4>Tags</h4>
				<ul id="tagList">
					@dataset.tags.map { tag =>
					  <li name='@tag.name'>
					  	<a href="@routes.Tags.search(tag.name)">@tag.name [Dataset]</a>
					  	<a href="javascript:void(0);"><span id="@tag.name" class="glyphicon glyphicon-remove" style="display:none;"></span></a>
					  </li>
					}
  				    @dataset.files.map { file =>
						@file.tags.map { tag =>
						  <li>
                              <a href="@routes.Tags.search(tag.name)">@tag.name [File]</a>
                          </li>
						}
				    	@file.sections.map { section =>
							@section.tags.map { tag =>
							  <li>
                                  <a href="@routes.Tags.search(tag.name)">@tag.name [Section]</a>
                              </li>
							}
						}
				   }
				</ul>
				<form class="form-inline requiresLogin">
					<div class="input-group input-group-sm col-md-8">
						<input type="text" id="tagField" class="form-control">
						<span class="input-group-btn">
							<button class="btn btn-default btn-large" id="tagB" title="Add Tag">
							    <span class="glyphicon glyphicon-tag"></span>
							</button>
						</span>
					</div>
				</form>
				<script language="javascript">
			     		window["userDefined"] = false;
			       </script>
				@if(user.isDefined) {
		      	   <script language="javascript">
			     		window["userDefined"] = true;
			       </script>
		      	}
				<script language="javascript">
					function removeTag(){
                        var tagId = $(this).attr("id");
                        console.log("Removing tag " + tagId);

                        var request = jsRoutes.api.Datasets.removeTags('@dataset.id').ajax({
                            data: JSON.stringify({"tags":[tagId]}),
                            type: 'POST',
                            contentType: "application/json"
                        });

                        request.done(function (response, textStatus, jqXHR){
                            console.log("Response " + textStatus);
                            $("#" + tagId).parents("li").remove();
                        });

                        request.fail(function (jqXHR, textStatus, errorThrown){
                        	console.error("The following error occured: " + textStatus, errorThrown);
                            var errMsg = "You must be logged in to remove a tag from a dataset.";                                
                            if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                                alert("The tag was not removed from the dataset due to : " + errorThrown);
                            }     
                        });

                        return false;
                    }
				
					function removeIconMouseIn() {
				   		$(this).find(".glyphicon-remove").fadeIn(100);
					}

					function removeIconMouseOut() {
				   		$(this).find(".glyphicon-remove").fadeOut(100);				   	
					}

					$(function() {
                       if(window["userDefined"] == true)
					   	$("#tagList").children("li").each(function(){
							$(this).hover(removeIconMouseIn,removeIconMouseOut);
                        });
                       $("#tagList").find(".glyphicon-remove").click(removeTag);
						
					   $('#tagB').click(function() {
					   	var tag = $('#tagField').val();
					     
					   	var isTagPresent = false;
					     $("#tagList").children("li").each(function (index, tagLi) {
					       if($(tagLi).attr("name")===tag){
					         isTagPresent = true;
					         alert(true);
					       }
					     });
	
					     if (tag !== "" && isTagPresent != true) {
						 	console.log("submitting tag " + tag);
					     	var request = jsRoutes.api.Datasets.addTags('@dataset.id').ajax({
					     		data: JSON.stringify({"tags":[tag]}),
						       type: 'POST',
						       contentType: "application/json"
						     });
						     
							request.done(function (response, textStatus, jqXHR){
								console.log("Response " + response);
						        var url = "../tags/search?tag=" + tag;
						        $newTag = $("<li><a href='" + url + "'>" + tag + " [Dataset]</a><a href='javascript:void(0);'><i style='display:none;'id='" + tag +"' class='glyphicon glyphicon-remove'></i></a></li>").appendTo('#tagList');
						        $newTag.hover(removeIconMouseIn,removeIconMouseOut);
     						    $newTag.find(".glyphicon-remove").click(removeTag);
						        $('#tagField').val("");
						    });
				    
							request.fail(function (jqXHR, textStatus, errorThrown){
								console.error("The following error occured: "+textStatus, errorThrown);
						        var errMsg = "You must be logged in to add a tag to a dataset.";
						        if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                                    alert("The tag was not added to the dataset due to : " + errorThrown);
                                } 
						     });
							return false;
						 }
					   });
					  
						$('#tagField').keypress(function (e) {
						  if (e.which == 13) {
						    console.log("enter");
						    $('#tagB').click();
						    return false;
						  }
						});
				  
				 });
			     </script>			     
			     @if(!user.isDefined) {
		      	   <script language="javascript">
			     		$(".requiresLogin").css("display","none");
			       </script>
		      	 }
		      	 @if(user.isDefined) {
		      	 	@if(!user.get.identityId.userId.equals(dataset.author.identityId.userId)){
			      	   <script language="javascript">
				     		$(".requiresLogin:not(.requiresLoginCommunity)").css("display","none");
				       </script>
			       }
		      	 }
			</div>
		</div>
	</div>
}

