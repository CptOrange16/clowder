@(dataset: models.Dataset,
        comments: List[Comment],
        filesTags: Set[String],
        previewers : List[Previewer],
        md: Map[String,Any],
        usrmd: scala.collection.mutable.Map[String,Any],
        collectionsInside: List[models.Collection],
        rdfExported: Boolean,
        relatedSensors: List[(String,String,String)],
        datasetSpaces: Option[List[ProjectSpace]],
        fileList: List[File])(implicit flash: play.api.mvc.Flash, user: Option[models.User])

@import helper._
@import api.Permission
@import collection.JavaConverters._
@import com.mongodb.casbah.Imports.DBObject

@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

	@printLevel(metadata: scala.collection.immutable.Map[String,Any]) = {		
		@for((key,value) <- metadata) {
			<li><b>@(key):</b>
			@if(value.isInstanceOf[String]) {
				@if(value.asInstanceOf[String].startsWith("http://") || value.asInstanceOf[String].startsWith("https://")) {
					<a href="@value">@value</a>
				} else {
					@value
				}
			} else {
				@if(value.isInstanceOf[java.lang.Integer]) {
					@value.toString
			    } else {
			    	@if(value.isInstanceOf[com.mongodb.BasicDBList]) {
			    		@value.toString.replace("[","").replace("]","")
			    	} else {
			    		<ul>
			    		@printLevel(value.asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
			    		</ul>
			    	}
			    }
			}</li>
		}
	}
	
	@printLevelUserMetadata(metadata: scala.collection.mutable.Map[String,Any]) = {
		<ul class="usr_md_">
		@for((key,value) <- metadata) {
			@if(value.isInstanceOf[com.mongodb.BasicDBList]){
				@for(listValue <- value.asInstanceOf[com.mongodb.BasicDBList]) {
						<li class="usr_md_"><b class="usr_md_">@(key):</b>
						@if(listValue.isInstanceOf[String]) {			
							<span class="usr_md_">@listValue</span><button class="usr_md_" type="button">Modify</button><button class="usr_md_" >Delete</button>
						} else {
								<button class="usr_md_" type="button">Add property</button><button class="usr_md_" type="button">Delete</button>@printLevelUserMetadata(listValue.asInstanceOf[DBObject].toMap.asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]])
						}</li>
				}
			}else{
				<li class="usr_md_"><b class="usr_md_">@(key):</b>
				@if(value.isInstanceOf[String]) {			
					<span class="usr_md_">@value</span><button class="usr_md_" type="button">Modify</button><button class="usr_md_" >Delete</button>
				} else {
						<button class="usr_md_" type="button">Add property</button><button class="usr_md_" type="button">Delete</button>@printLevelUserMetadata(value.asInstanceOf[DBObject].toMap.asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]])
				}</li>
			}	
		}
		</ul>
	}

@main("Dataset") {
	<div class="row">
		<!-- left column -->
		<div class="col-md-8 col-right-border">

            <div class="row">
                <div class="col-md-12" id="ds-title">
                    <h1 id="datasettitle" class="inline">@Html(dataset.name)</h1>
                    @if(Permission.checkPermission(Permission.EditDataset, ResourceRef(ResourceRef.dataset, dataset.id))) {
                        <h3 class="inline align-right"><a id ="edit-title" href = "javascript:updateTitle()">
                            <span class ="glyphicon glyphicon-edit" aria-hidden ="true"></span>
                        </a></h3>
                    }

                </div>



                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li>Created by <a href= "@routes.Profile.viewProfile(dataset.author.email)"> @dataset.author.fullName </a></li>
                                <li>Created on @dataset.created.format("MMM dd, yyyy")</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="inline"><span id="licensetextdata">blank</span> <span id="rightsholderdata">blank</span></li>
                                @datasets.editLicense(dataset)
                            </ul>
                        </div>


                <div class="col-md-12 box-white-space" id="aboutdesc">
                    <p id ="ds_description" class="inline">@Html(dataset.description)</p>
                    @if(Permission.checkPermission(Permission.EditDataset, ResourceRef(ResourceRef.dataset, dataset.id))) {
                        <a id="edit-description" href="javascript:updateDescription()">
                            <span class="edit-tab glyphicon glyphicon-edit" aria-hidden="true"></span>
                        </a>
                    }

                </div>

                <div class="col-md-12 box-white-space">

                    @datasets.deleteButton(dataset)
                    @datasets.follow(dataset)
                </div>
            </div>

            <br/>
	    	<div class="tabbable" id="bottomDatasetTabbable"> <!-- Only required for left/right tabs -->
                <ul class="nav nav-tabs">
                    <li role="presentation" class="active"><a href="#tab-files" role="tab" data-toggle="tab">Files (@dataset.files.size)</a></li>
                    <li role="presentation"><a href="#tab-metadata" role="tab" data-toggle="tab">Metadata (@(usrmd.size + md.size))</a></li>
                    <li role="presentation"><a href="#tab-comments" role="tab" data-toggle="tab">Comments (@comments.size)</a></li>
                    <li role="presentation"><a href="#tab-notes" role="tab" data-toggle="tab">Notes</a></li>
                </ul>
                <div class="tab-content">
                  <div role="tabpanel" class="tab-pane  fade in active" id="tab-files">
                      <div id="add-file-btn">
                      <!-- If the user can add files to the dataset, the button is enabled, otherwise the button is present but disabled to provide consistent UE. -->
                      @if(Permission.checkPermission(Permission.AddResourceToDataset, ResourceRef(ResourceRef.dataset, dataset.id))) {
                          <a href="@(routes.Datasets.addToDataset(dataset.id))"
                          class="btn btn-primary btn-sm" id="fileUploadBtn" title="Add File to Dataset" role="button">
                              <span class="glyphicon glyphicon-export"></span> Add File
                          </a>
                      } else {
                          <a href="@(routes.Datasets.addToDataset(dataset.id))"
                          class="btn btn-primary btn-sm disabled" id="fileUploadBtn" title="Add File to Dataset" role="button">
                              <span class="glyphicon glyphicon-export"></span> Add File
                          </a>
                      }
                      </div>
                      @if(dataset.files.length > 0 && Permission.checkPermission(Permission.DownloadFiles, ResourceRef(ResourceRef.dataset, dataset.id))) {
                          <a id='download-dataset-url' href="#"
                          onclick="window.open(jsRoutes.api.Datasets.download('@dataset.id').url, '_blank');"
                          class="btn btn-default btn-sm requiresLogin" title="Download All Files as Zip" role="button">
                              <span class="glyphicon glyphicon-download-alt"></span>
                              Download All Files
                          </a>
                      }
                      @files.grid(fileList, dataset.id)
                  </div>
                  <div role="tabpanel" class="tab-pane fade" id="tab-comments">
                      <!-- If the user can add comments, the form will be present, otherwise the form is not available at all. -->
                      @if(Permission.checkPermission(Permission.AddComment, ResourceRef(ResourceRef.dataset, dataset.id))) {
                          @commentform(dataset.id.stringify, "dataset")
                      }
                      <div class="list-unstyled" id="reply_@dataset.id.toString">
                         @comment(comments)</div>
                  </div>
                  <div role="tabpanel" class="tab-pane fade" id="tab-metadata">
                    @metadata(dataset, md, usrmd, dataset.datasetXmlMetadata, rdfExported)
                  </div>
                  <!-- If the user can create a note on this dataset, display this tab. Otherwise, remove it. Is there a better way to do this? -->
                  @if(Permission.checkPermission(Permission.CreateNote, ResourceRef(ResourceRef.dataset, dataset.id))) {
                      <div role="tabpanel" class="tab-pane fade" id="tab-notes">
                      @notesform(dataset.id.toString, api.routes.Datasets.setNotesHTML(dataset.id).toString, dataset.notesHTML.getOrElse(""))
                      </div>
                  }

            </div>
			</div>
		</div>

		<!-- right column -->
		<div class="col-md-4 col-left-border">
            @spaces.spaceAllocation(dataset.id, ResourceRef.dataset, datasetSpaces.getOrElse(List.empty))
            @if(user.isDefined) {
                <br/>
                @datasets.userLink(dataset)
            }
            @datasets.collections(dataset, collectionsInside)
            @datasets.tags(dataset, fileList, filesTags)

            @if(play.api.Play.current.plugin[services.PostgresPlugin].isDefined) {
                @sensors.relatedSensors(relatedSensors, "Dataset", dataset.id.stringify)
            }
		</div>
	</div>

    @* FIXME Commented out since it creates some issues with dataset previewers *@
    @*<script src="@routes.Assets.at("javascripts/tabsInURL.js")" type="text/javascript"></script>*@

    <script src="@routes.Assets.at("javascripts/errorRedirect.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/updateLicenseInfo.js")" language="javascript"></script>
    <script src="@routes.Assets.at("javascripts/tinymce/tinymce.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/datasetListProcess.js")" type="text/javascript"></script>
    <script>
        tinymce.init ( { selector : '.notesArea',
            theme : "modern",
            plugins :[
                "advlist autolink lists link image charmap print preview hr anchor pagebreak",
                "searchreplace wordcount visualblocks visualchars code fullscreen",
                "insertdatetime media nonbreaking save table contextmenu directionality",
                "template paste textcolor"
            ],
            toolbar1 : "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | " +
                        "bullist numlist outdent indent | link image",
            toolbar2 : "print preview media | forecolor backcolor emoticons",
            image_advtab : true,
            templates :[ { title : 'Test template 1', content : 'Test 1' }, { title : 'Test template 2', content : 'Test 2' }
            ]
            } ) ;
        function updateTitle() {
            var cur_title = $('#datasettitle').text();
            $('<input type="text" id = "title_input" class="form-control"/>').insertAfter($('#datasettitle'));
            $('<button id="update_title" class= "btn btn-sm btn-primary" onclick="saveTitle()"> Save </button>').insertAfter($('#title_input'));
            $('#title_input').val(cur_title);
            $('#datasettitle').text("");
            $('#edit-title').css("display", "none");
        }

        $(document).ready(function(){
            if(@dataset.spaces.size < 1 ) {
                $('#dataset-users').hide();
            }
        });
        function saveTitle() {
            var name = $('#title_input').val();
            var encName = htmlEncode(name);
            jsonData = JSON.stringify({"name": encName});

            var request = jsRoutes.api.Datasets.updateName("@dataset.id").ajax({
                data: jsonData,
                type: 'PUT',
                contentType: "application/json"
            });

            request.done(function(response, textStatus, jqXHR){
                $('#datasettitle').text(encName.replace(/\n/g, "<br>"));
                $('#title_input').remove();
                $('#update_title').remove();
                $('#edit-title').css("display", "inline");
                $('#datasettitle').css("display", "inline");

            });

            request.fail(function(jqXHR, textStatus, errorThrown) {
                console.error("The following error occurred: " + textStatus, errorThrown);
                var errMsg = "Yoy must be logged in to update the information about a dataset.";
                if(!checkErrorAndRedirect(jqXHR, errMsg)) {
                    notify("The dataset information was not updated due to: "+ errorThrown, "error");
			};
		});

        }


         function updateDescription() {
		var cur_description = $('#ds_description').text().trim();
		$('<div class="edit_desc"> </div>').insertAfter($('#ds_description'));
		$('.edit_desc').append('<textarea id = "desc_input" class="form-control"/>');
		$('.edit_desc').append('<br/>');
		$('.edit_desc').append('<button id = "update_desc" class= "btn btn-sm btn-primary" onclick = "saveDescription()"> Save </button>')
		$('#desc_input').val(cur_description);
		$('#ds_description').text("");
		$('#edit-description').css("display", "none");
	}

	function saveDescription() {
		var description = $('#desc_input').val();
		var encDescription = htmlEncode(description);
		jsonData = JSON.stringify({"description": description});

		var request = jsRoutes.api.Datasets.updateDescription("@dataset.id").ajax({
			data: jsonData,
			type: 'PUT',
			contentType: "application/json"
		});

		request.done(function(response, textStatus,jqXHR) {
			$('#ds_description').text(encDescription);
			$('.edit_desc').remove();
			$('#edit-description').css("display", "inline");
			$('#ds_description').css("display", "inline");

		});

		request.fail(function(jqXHR, textStatus, errorThrown) {
			console.error("The following error occurred: " + textStatus, errorThrown);
			var errMsg = " You must be logged in to update the information about a collection.";
			if(!checkErrorAndRedirect(jqXHR, errMsg)) {
				notify("The collection information was not updated due to: " + errorThrown, "error");
			}
		});
	}
    </script>
}

